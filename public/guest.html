<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Have Fun!</title>
    <style>
      .ui-helper-hidden-accessible {
        display: none;
      }
      /* searchSuggest can be used defind the style of the autocomplete style */
      .searchSuggest {
        background-color: rgb(148, 129, 165);
      }
    </style>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <button id="addSong" data-songid="3" data-action="thumbdown">
      Test Button
    </button>
    <form>
      <input type="text" id="music-input" placeholder="Enter Song Name" />Input
      Music Name <br />
      <input type="submit" />
    </form>

    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      let data = "";
      let at;
      let input = $("#music-input").val();

      // * this function will run as soon as script loaded.
      // * data is a array. a list of track. FRONTEND
      // * at means access token. coming from backend database table token
      (function() {
        $.get("/api/guest", function(response) {
          data = response.data;
          at = response.token[0].accessToken;
          console.log(response);
          console.log(data);
          console.log(at);
        });
      })();
      // Autocomplete. when guest input more than 3 characters , the function will be fired.
      //function input{access token}(coming from the /api/guest) and {query term}
      $("#music-input").autocomplete({
        source: function(request, response) {
          $.ajax({
            type: "GET",
            url: "https://api.spotify.com/v1/search",
            headers: {
              Authorization: `Bearer ${at}`,
              Accept: "application/json",
              "Content-Type": "application/json"
            },
            data: {
              type: "track",
              q: request.term,
              limit: 10,
              market: "US",
              offset: 3
            },
            success: function(data) {
              console.log(data.tracks.items);
              response(
                $.map(data.tracks.items, function(item) {
                  // console.log(item.artists);
                  return {
                    lable: `${item.name} by ${item.artists[0].name}`,
                    value: `${item.name} by ${item.artists[0].name}`,
                    id: item.id,
                    meta_name: `${item.name}`,
                    meta_uri: `${item.uri}`,
                    meta_artist: `${item.artists[0].name}`
                  };
                })
              );
            }
          });
        },
        minLength: 3,
        select: function(event, ui) {
          $("#music-input").val(ui.item.value);
          // console.log(ui.item.meta_uri);
          let meta_data = {
            name: ui.item.meta_name,
            artist: ui.item.meta_artist,
            uri: ui.item.meta_uri
          };
          console.log(meta_data);
          (function() {
            console.log("111111");
          })();
          $.post("/music/add", meta_data).then(function(meta_data) {
            console.log("new music added" + meta_data);
            alert("omg");
          });
        }
      });
      $.ui.autocomplete.prototype._renderItem = function(ul, item) {
        console.log(item);
        return $("<li>")
          .addClass("searchSuggest")
          .text(`${item.lable}`)
          .appendTo(ul);
      };

      document.getElementById("addSong").addEventListener(
        "click",
        function() {
          $.get("/api/thumbdown/17").then(function(data) {
            return;
          });
        },
        false
      );
      //tracking info
    </script>
  </body>
</html>
